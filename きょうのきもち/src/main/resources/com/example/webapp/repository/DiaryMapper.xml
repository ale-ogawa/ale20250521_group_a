<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.webapp.repository.DiaryMapper">

	<select id="findLatestScopes"
		resultType="com.example.webapp.entity.Scope">
		SELECT group_id, setting
		FROM scopes
		WHERE diary_id = (
			SELECT id
			FROM diaries
			WHERE account_id = #{accountId}
			ORDER BY date DESC
			LIMIT 1
		) ORDER BY group_id
		
	</select>

	<select id="findToday"
		resultType="com.example.webapp.entity.Diary">
		SELECT id, feeling, text, date
		FROM diaries
		WHERE account_id = #{accountId} and date = #{localDate}
	</select>
	
	<select id="findScopes"
		resultType="com.example.webapp.entity.Scope">
		SELECT group_id, setting
		FROM scopes
		WHERE diary_id = #{diaryId}
		ORDER BY group_id
	</select>
	
	<select id="findGroups"
		resultType="com.example.webapp.entity.Group">
		SELECT id, name
		FROM groups
		WHERE account_id = #{accountId}
		ORDER BY id
	</select>
	
	<select id="findTodaysTaking"
		resultType="com.example.webapp.entity.DailyTaking">
		SELECT t.id AS taking_id, t.time AS taking_time,
		m.id AS medicine_id, m.name AS medicine_name
		FROM takings t
		JOIN medicine_taking mt ON t.id = mt.taking_id
		JOIN medicines m ON mt.medicine_id = m.id
		WHERE t.account_id = #{accountId}
		AND DATE(t.time) = #{localDate}
		ORDER BY taking_time, m.id
	</select>
	
	<select id="findFeelings"
		resultType="com.example.webapp.entity.Diary">
		SELECT date, feeling, text
		FROM diaries
		WHERE date BETWEEN #{firstDay} AND #{lastDay}
	</select>
	
	<select id="findReactions"
		resultType="com.example.webapp.entity.DailyReaction">
		SELECT r.stamp, r.comment, a.nickname
		FROM reactions r
		JOIN accounts a ON r.account_id = a.id
		WHERE a.follow_id = #{accountId}
		AND r.diary_id = #{diaryId};
	</select>
	
	<select id="findVisible">
		SELECT setting FROM scopes
		WHERE diary_id = #{diaryId}
		AND group_id = #{groupId}
	</select>
	
</mapper>